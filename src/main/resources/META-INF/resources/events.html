<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="cache-control" content="no-cache"/>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	
	<title>Communities of Practice - Events</title>
	
	<link href="css/jquery.dataTables.min.css" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="https://static.redhat.com/libs/redhat/redhat-font/2/webfonts/red-hat-font.css" media="all" />
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="css/style2.css" type="text/css">
	
	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/jquery.dataTables.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/ChartNew.js"></script>
	<script src="js/utils.js"></script>
	<script src="js/http.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.6.4/showdown.min.js"></script>
	<script>
		var jwtToken = "";
		var contextPath = "";
		var table=undefined;
		var baseUrl=window.location.origin;
		var ajaxUrl="/api/v2/events";
	</script>
</head>
<body>

<style>
.container {
    display: inline-block;
    cursor: pointer;
    width: 50px !important;
}
.bar1, .bar2, .bar3 {
    width: 35px;
    height: 4px;
    background-color: #333;
    margin: 6px 0;
    transition: 0.4s;
}
.change .bar1 {
    -webkit-transform: rotate(-45deg) translate(-5px, 8px) ;
    transform: rotate(-45deg) translate(-5px, 8px) ;
}
.change .bar2 {
    opacity: 0;
}
.change .bar3 {
    -webkit-transform: rotate(45deg) translate(-8px, -8px) ;
    transform: rotate(45deg) translate(-8px, -8px) ;
}
.adjustment{
	padding-top: 0px !important;
	padding-bottom: 0px !important;
}
.adjustment>div{
	padding: 10px 10px !important;
}
table tr td:nth-child(1), table tr td:nth-child(2){
	white-space: nowrap;
}
.export button{
	height: 26px;
    padding: 0px;
    padding-left: 11px;
    padding-right: 12px;
}
.export div .dropdown-item{
	padding-left: 10px;
}
#filtersBar{
	padding-left: 15px;
	display: grid;
	grid-template-columns: 1fr 8fr;
	grid-gap: 2px 8px;
}
label{margin-right:10px;}
</style>
<script>
function myFunction(x) {
    x.classList.toggle("change");
}
</script>

<div id="main_nav" class="navbar">
  <div class="navbar-header">
    <a href="/" class="navbar-brand2"><img role="logo" src="images/logo.svg"/>
    	<span class="navbar-brand3"></span>
    </a>
  </div>
  <div class="collapse navbar-collapse bs-example-js-navbar-collapse">
    <ul class="nav navbar-nav">
      <li class="dropdown">
        <a aria-expanded="false" aria-haspopup="true" role="button" data-toggle="dropdown" class="menu-title dropdown-toggle" href="#" id="drop2">
          Ninja Program
          <span class="caret"></span>
        </a>
        <ul aria-labelledby="drop2" class="dropdown-menu">
          <li><a href="scorecards.html">Scorecards</a></li>
          <li><a href="leaderboard.html">Leaderboard</a></li>
          <li><a href="events.html">Events</a></li>
          <li><a href="tasks.html">Tasks</a></li>
          <li><a href="https://docs.google.com/a/redhat.com/forms/d/e/1FAIpQLSdWGcCks2zKKnVoZFQz3CieLQDc1lsSex_Knwh_-eyRm0ZQTg/viewform">Registration Form</a></li>
          <li><a href="https://docs.google.com/spreadsheets/d/1E91hT_ZpySyvhnANxqZ7hcBSM2EEd9TqfQF-cavB8hQ">Responses Spreadsheet</a></li>
          <li><a href="support-trello-card.html">Support - Trello Query</a></li>
          <li><a href="support-trello-all.html">Support - Trello Reconcilliation</a></li>
        </ul>
      </li>
    </ul>
    <ul class="nav navbar-nav">
      <li class="dropdown">
        <a aria-expanded="false" aria-haspopup="true" role="button" data-toggle="dropdown" class="menu-title dropdown-toggle" href="#" id="drop2">
          Admin
          <span class="caret"></span>
        </a>
        <ul aria-labelledby="drop2" class="dropdown-menu">
          <li><a href="config.html">Config (Here be dragons!)</a></li>
          <li><a href="database.html">Database (Here be dragons!)</a></li>
        </ul>
      </li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown" id="fat-menu">
        <a aria-expanded="false" aria-haspopup="true" role="button" data-toggle="dropdown" class="dropdown-toggle adjustment" href="#" id="drop3">
          <div class="container" onclick="myFunction(this)" style="height:56px">
					  <div class="bar1"></div>
					  <div class="bar2"></div>
					  <div class="bar3"></div>
					</div>
          <span class="caretx"></span>
        </a>
        <ul aria-labelledby="drop3" class="dropdown-menu">
          <li><a href="api/logout">Log out</a></li>
        </ul>
      </li>
    </ul>
  </div>
</div>

<div class="navbar-connector"></div>
<div class="navbar-title">
	<h2><span class="navbar-title-text">Events<span id="title-user"></span></span></h2>
</div>

<div id="filtersBar">
	<div><label for="user">User ID (Kerberos)</label></div>             <div><input type="text" id="user"/></div>
	<div><label for="manager">Line Manager ID (Kerberos)</label></div>  <div><input type="text" id="manager"/></div>
	<div><label for="daysOld">Days old</label></div>                    <div><input type="number" id="daysOld"/></div>
	<div><label for="events">Event types</label></div>                  <div><input type="hidden" id="events"/>

		<label for="pointsIncrement"><input type="checkbox" class="events" id="pointsIncrement" checked onclick="return group('events');" value="Points Increment"/>   Points Increment            </label>
		<label for="userPromotion">  <input type="checkbox" class="events" id="userPromotion"   checked onclick="return group('events');" value="User Promotion"/>     User Promotion              </label>
		<label for="newUser">        <input type="checkbox" class="events" id="newUser"         checked onclick="return group('events');" value="New User"/>                   New User                    </label>
		<label for="lostPoints">     <input type="checkbox" class="events" id="lostPoints"      checked onclick="return group('events');" value="Lost Points"/>                Lost Points                 </label>
		<label for="scriptSucceeded"><input type="checkbox" class="events" id="scriptSucceeded" checked onclick="return group('events');" value="Script Execution Succeeded"/> Script Execution Succeeded  </label>
		<label for="scriptFailed">   <input type="checkbox" class="events" id="scriptFailed"    checked onclick="return group('events');" value="Script Execution FAILED"/>    Script Execution FAILED     </label>

	</div>
	
	<script>
	group("events");
	function group(selector){
	    $('#'+selector).val("")
	    var allVals = $('input.'+selector+':checked').map(function() {return this.value;}).get().join();
	    $('#'+selector).val(allVals)
	}
	</script>
	
	<div></div><div><button onclick="return loadDataTable();">Filter</button></div>
</div>

<div id="solutions">
	<div id="solutions-buttonbar"></div>
	<div id="tableDiv">
		<table id="example" class="display" cellspacing="0" width="100%">
			<thead>
				<tr>
					<th align="left">Timestamp</th>
					<th align="left">Type</th>
					<th align="left"></th>
					<th align="left">User</th>
				</tr>
			</thead>
		</table>
	</div>
</div>

<script>
function loadDataTable(){
  var textFilter=Utils.getParameterByName("filter")!=undefined?Utils.getParameterByName("filter"):"";
  
  if (table!=undefined){
	  var params="";
	  $("input[type=text],input[type=number],input[type=hidden]").each(function(){
		  if (Utils.isNotBlank($(this).val())){
			  params+="&"+$(this).attr("id")+"="+$(this).val();
		  }
	  });
	  params=params.substring(1);
	  
	  ajaxUrl="/api/v2/events?"+params;
	  
	  $('.export-type').each(function(){
		  $(this).attr("href", $(this).attr("base-href")+"?"+params)
	  });
	  
	  window.history.pushState("object or string", "Title", "?"+params);
	  
	  table.clear().draw();
	  table.ajax.url( ajaxUrl ).load();
  }else{
  	table=$('#example').DataTable( {
	        "ajax": {
	            "url": ajaxUrl,
	            "dataSrc": ""
	        },
	        "scrollY": "1300px",
	        "scrollCollapse": true,
	        "paging": false,
	        "lengthMenu": [[10, 25, 50, 100, 200, -1], [10, 25, 50, 100, 200, "All"]],
	        "pageLength" : 5,
	        "order" : [[0,"desc"]],
	        "oSearch": {"sSearch": textFilter},
	        "columns": [
	            { "data": "timestamp" },
	            { "data": "type" },
	            { "data": "text" },
	            { "data": "user" }
	        ],"columnDefs": [
	            { "targets": 2, "orderable": true, "render": function (data,type,row){
	              
	              var result=row['text'];
	              
	              if (typeof showdown !== 'undefined'){
	            		var markDownConverter = new showdown.Converter();
	        				var str = markDownConverter.makeHtml(result);
	        				if (str!=undefined){
		        				if (str==undefined || str.length<=3) console.log("error: str="+result)
		        				str = str.substring(3);
		        				str = str.substring(0, str.length - 4);
		        				result = str;
	        				}
	            	}
	              
	              return result;
	            }},  
	            { "targets": 3, "orderable": true, "render": function (data,type,row){
	              return row['user'];
	            }}
	        ]
	    } );
  	}
}

function addExportButton(){
   var btnExport=`
      <div style="left:-20px;float:left;" class="dropdown export">
      	<button class="btn btn-secondary dropdown-toggle" type="button" onclick="copyToClipboard(baseUrl+ajaxUrl);">Copy Url</button>
      	
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Export
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <a class="dropdown-item export-type" id="export-csv"  base-href="api/v2/events/export/csv">... as CSV</a><br/>
          <a class="dropdown-item export-type" id="export-xls"  base-href="api/v2/events/export/xls">... as XLS</a><br/>
          <a class="dropdown-item export-type" id="export-json" base-href="api/v2/events/export/json">... as JSON</a>
        </div>
      </div>
      `;
	    
     var searchBoxDiv=document.querySelector("#example_filter");
     var wrapper=searchBoxDiv.parentNode;
     var newNode = document.createElement("span");
     newNode.innerHTML=btnExport+"&nbsp;";
     searchBoxDiv.appendChild(newNode);
}

function copyToClipboard(text) {
  window.prompt("Copy to clipboard: Ctrl+C, Enter", text);
}

$(document).ready(function() {
  if (null!=Utils.getParameterByName("name")){
    document.getElementById("title-user").innerText=": "+Utils.getParameterByName("name");
  }
  loadDataTable();
  addExportButton();
});
</script>

</body>
</html>

